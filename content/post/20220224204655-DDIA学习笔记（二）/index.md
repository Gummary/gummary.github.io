---
title: "DDIA学习笔记（二）"
slug: DDIA学习笔记（二）
date: 2022-02-24T20:46:55+08:00
draft: true
---

<!--more-->

# Chapter 5. Replication

将数据分布在多个数据节点上的好处：

1. 让数据和用户中间的物理距离更小，相应速度更快
2. 提高系统容错性
3. 提高系统读的吞吐率

## Leaders and Followers

为了保证各个节点的数据一致，通常采用的架构为主从式，如下图所示：

{{< tfigure src="images/20220518000016.png" title="" width="" class="align-center">}}

1. 用户将写请求发给主节点
2. 主节点处理请求
3. 主节点将修改请求转发给其他节点，其他节点再处理

## Synchronous Versus Asynchronous Replication

主节点与从节点之间的交互有三种：

1. 同步方式，主节点将更新请求发给所有从节点，所有从节点都更新成功，主节点才给客户端返回更新成功。但如果有网络波动或从节点异常，那客户端进行写操作时就会被阻塞或写入失败。
2. 异步方式，主节点给从节点发送更新请求后，不等从节点的返回结果，直接返回客户端。提高客户端的写效率，但无法保证从节点更新数据成功。
3. 半异步方式，某一个或几个节点使用同步的方式，其他节点使用异步的方式。保证至少有一个从节点的数据是完整的。

## Setting Up New Followers

数据集群中加入一个新的节点：

1. 构造一个老数据库的SNAPSHOT（这一步可以不需要锁）
2. 将SNAPSHOT发送给从节点
3. 从节点请求从SNAPSHOT至当前所有的新数据
4. 从节点处理完数据后即可作为一个新的节点工作

## Handling Node Outages

处理节点下线的难点在于，如何保证整个集群正常工作的情况下，重启某个节点。节点恢复之后，又能保证数据不丢失。

### Follower failure: Catch-up recovery

从节点本地存储了一份数据修改的日志，因此当从节点下线后，从节点可以从日志中回复数据，下线过程中新增的数据可以从主节点重新请求得到。

### Leader failure: Failover

主节点下线之后的处理流程通常如下：

1. 确定主节点下线。通常使用timeout机制判断节点是否下线
2. 选择一个新的主节点。在所有的从节点中，选出一个数据最全的从节点作为主节点。（共识算法）
3. 让客户端将更新请求转发给新的主节点，从节点向新的主节点请求数据。

这个处理流程中有很多问题：

1. 如果使用异步的方式进行同步，那么新选出的主节点可能信息不全。如果原来的主节点重启后重新加入集群，那么就会存在数据不一致的问题。通常处理方式是，丢弃原来主节点上新的数据。
2. 丢弃原来主节点的数据很容易会导致其他问题。特别是当有一些其他系统依赖本系统的数据的时候。
3. 某些情况下，可能会选出来两个节点当作主节点，这就会导致两个主机点之间的数据不一致，又没有合适的冲突处理方式，导致数据不完整。
4. 主节点的超时时间设置比较难。如果设置很大，那么检测出主节点超时就比较困难；而如果比较小，那么可能一次网络波动就会导致failover，影响性能。

## Implementation of Replication Logs

主从节点实现复制的方式有以下四种

### Statement-based replication

将每个更新数据的语句发送给从节点。

缺点：

1. 需要保证非确定性函数如RAND、NOW等的一致性。主库可以将语句中的非确定函数改为一个固定值来避免。
2. 如果更新操作有一些副作用，那么要保证这些副作用的结果一致。
3. 如果更新数据需要依赖库中的数据，那么要保证更新数据语句执行的次序是一致的。


### Write-ahead log (WAL) shipping

- 对于Log型的存储引擎，如SSTable、LSM-Tree等，数据主要存储在日志文件中
- 对于B-Tree，数据在更新前也会先写入一个日志文件中，供恢复使用。

因此对于这些数据引擎，实现数据的复制就可以通过发送日志完成。主节点除了写入日志，还会通过网络将日志发送给从节点。

这种复制方式的缺点在于，日志描述的数据库数据文件中哪些数据被修改了，因此日志的文件存储结构和存储引擎是强绑定的。

### Logical (row-based) log replication

另一种实现日志的方式是将日志的结构和存储引擎解耦。日志用于记录数据的修改内容：

1. 对于插入行，记录所有列的值
2. 对于删除行，记录插入的数据的唯一标识
3. 对于更新行，记录唯一标识和更新后的值

使用这种日志的好处是，从节点更容易进行存储引擎版本升级，甚至使用不同的存储引擎，日志还可以被其他应用程序使用。

### Trigger-based replication

之前三种都是数据库引擎本身的复制能力。有些情况下需要更大的灵活性，使用用户编写的程序实现数据复制。这种情况下可以使用数据库提供的触发器功能。应用程序首先注册数据的更新，在数据更新后，数据库调用应用程序代码。