<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Java Bean Validation with Spring Boot - Gum</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="Gum"><meta name=description content="在应用程序中，为了确保程序运行正确，通常需要对用户输入进行校验。Java中为了对Bean进行校验先后发布了JSR 303、JSR 349、JSR 380，帮助Java开发者快速校验Java Bean。作为Java应用开发中的主流框架Spring，也大量使用了Java Bean Validation。本文先简单介绍Java Bean Validation的发展历史，然后介绍在Spring中如何应用，最后介绍Spring中Bean Validation的实现原理。
"><meta name=keywords content="Photo,Reading,Java,Distribute System"><meta name=generator content="Hugo 0.110.0 with theme even"><link rel=canonical href=http://localhost:1313/post/java-bean-validation-with-spring-boot/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.40f3224b12ad17cb3dd58c8d5dfc3d1d6ad48ed6335de8962e4710a613bf3702.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="Java Bean Validation with Spring Boot"><meta property="og:description" content="在应用程序中，为了确保程序运行正确，通常需要对用户输入进行校验。Java中为了对Bean进行校验先后发布了JSR 303、JSR 349、JSR 380，帮助Java开发者快速校验Java Bean。作为Java应用开发中的主流框架Spring，也大量使用了Java Bean Validation。本文先简单介绍Java Bean Validation的发展历史，然后介绍在Spring中如何应用，最后介绍Spring中Bean Validation的实现原理。"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/post/java-bean-validation-with-spring-boot/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-30T11:08:53+08:00"><meta property="article:modified_time" content="2023-01-30T11:08:53+08:00"><meta itemprop=name content="Java Bean Validation with Spring Boot"><meta itemprop=description content="在应用程序中，为了确保程序运行正确，通常需要对用户输入进行校验。Java中为了对Bean进行校验先后发布了JSR 303、JSR 349、JSR 380，帮助Java开发者快速校验Java Bean。作为Java应用开发中的主流框架Spring，也大量使用了Java Bean Validation。本文先简单介绍Java Bean Validation的发展历史，然后介绍在Spring中如何应用，最后介绍Spring中Bean Validation的实现原理。"><meta itemprop=datePublished content="2023-01-30T11:08:53+08:00"><meta itemprop=dateModified content="2023-01-30T11:08:53+08:00"><meta itemprop=wordCount content="4202"><meta itemprop=keywords content="Java,Spring,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Java Bean Validation with Spring Boot"><meta name=twitter:description content="在应用程序中，为了确保程序运行正确，通常需要对用户输入进行校验。Java中为了对Bean进行校验先后发布了JSR 303、JSR 349、JSR 380，帮助Java开发者快速校验Java Bean。作为Java应用开发中的主流框架Spring，也大量使用了Java Bean Validation。本文先简单介绍Java Bean Validation的发展历史，然后介绍在Spring中如何应用，最后介绍Spring中Bean Validation的实现原理。"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Gum</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Gum</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Java Bean Validation with Spring Boot</h1><div class=post-meta><span class=post-time>2023-01-30</span><div class=post-category><a href=/categories/spring/>spring</a></div><span class=more-meta>4202 words</span>
<span class=more-meta>9 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#java-bean-validation发展历史>Java Bean Validation发展历史</a></li><li><a href=#spring中应用java-bean-validation>Spring中应用Java Bean Validation</a><ul><li><a href=#spring-controller参数校验>Spring Controller参数校验</a><ul><li><a href=#统一处理校验错误>统一处理校验错误</a></li></ul></li><li><a href=#自定义校验器>自定义校验器</a></li><li><a href=#service层进行校验>Service层进行校验</a></li><li><a href=#显式校验>显式校验</a></li></ul></li><li><a href=#spring参数校验源码分析>Spring参数校验源码分析</a><ul><li><a href=#校验类加载>校验类加载</a><ul><li><a href=#校验切面>校验切面</a></li></ul></li><li><a href=#post参数校验>POST参数校验</a></li><li><a href=#get参数校验>GET参数校验</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考文献>参考文献</a></li></ul></nav></div></div><div class=post-content><p>在应用程序中，为了确保程序运行正确，通常需要对用户输入进行校验。Java中为了对Bean进行校验先后发布了JSR 303、JSR 349、JSR 380，帮助Java开发者快速校验Java Bean。作为Java应用开发中的主流框架Spring，也大量使用了Java Bean Validation。本文先简单介绍Java Bean Validation的发展历史，然后介绍在Spring中如何应用，最后介绍Spring中Bean Validation的实现原理。</p><h1 id=java-bean-validation发展历史>Java Bean Validation发展历史</h1><p>Emmanuel Bernard在2009年发布了JSR 303（Bean Validation 1.0），在该标准中定义了如何使用注解对JavaBean进行校验；Emmanuel于2013年又发布了JSR 349（Bean Validation 1.1），在该版本中引入了对方法参数校验、校验器依赖注入等特性的支持；在Java8发布后，Gunnar Morling于201年又发布了JSR 380（Bean Validation 2.0），该版本中大量使用了Java8的新特性，如Optional、Lambda表达式、Type Annotation等。</p><figure class=align-center><img src=https://blog-1302636809.file.myqcloud.com/post/java-bean-validation-with-spring-boot/images/spring-validation-history.png></figure><p>Hibernate Validator是JSR 380的一个参考实现，被业界广泛使用，能够在展示层、业务层、数据层对输入进行校验。</p><figure class=align-center><img src=https://blog-1302636809.file.myqcloud.com/post/java-bean-validation-with-spring-boot/images/20230130142747.png></figure><h1 id=spring中应用java-bean-validation>Spring中应用Java Bean Validation</h1><p>在Spring也有对Java Bean Validation的封装，maven组件为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.springframework.boot<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>spring-boot-starter-validation<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=spring-controller参数校验>Spring Controller参数校验</h2><p>在使用Spring进行Web开发时，接收参数的方式有以下两种：</p><ol><li>对于HTTP GET等请求，通常使用@RequestParam、@PathVariable注解接收请求参数及URL中的参数；</li><li>对于HTTP POST请求，通常是用@RequestBody注解接受请求体。</li></ol><p>下面看下如何对GET、POST请求进行参数校验。</p><p>首先定义接受请求参数的类，并对类中的参数增加校验项：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@Builder</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserVO</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>Long</span> <span class=n>id</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@NotBlank</span><span class=o>(</span><span class=n>message</span> <span class=o>=</span> <span class=s>&#34;名称不能为空&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>name</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Email</span><span class=o>(</span><span class=n>message</span> <span class=o>=</span> <span class=s>&#34;邮箱格式错误&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>email</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>GET请求中，如果参数数量较少，可以使用简单类型并使用@RequestParam注解接收参数，然后给需要校验的参数加校验注解；如果参数数量过多，可以将参数聚合到一个类中，然后给该类的参数添加@Valid注解。无论是使用简单类型还是类来接收参数，都<strong>必须</strong>在Contoller类上加@Validated注解。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@Validated</span>
</span></span><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserQueryController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=s>&#34;/user/query/id&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>UserVO</span> <span class=nf>queryUserById</span><span class=o>(</span><span class=nd>@RequestParam</span> <span class=nd>@Min</span><span class=o>(</span><span class=mi>5</span><span class=o>)</span> <span class=kt>int</span> <span class=n>id</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;[queryUserById] {}&#34;</span><span class=o>,</span> <span class=n>id</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@GetMapping</span><span class=o>(</span><span class=s>&#34;/user/query/full&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>UserVO</span> <span class=nf>queryUser</span><span class=o>(</span><span class=nd>@Valid</span> <span class=n>UserVO</span> <span class=n>userVo</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>JsonProcessingException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ObjectMapper</span> <span class=n>objectMapper</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ObjectMapper</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;[queryUser] {}&#34;</span><span class=o>,</span> <span class=n>objectMapper</span><span class=o>.</span><span class=na>writeValueAsString</span><span class=o>(</span><span class=n>userVo</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于POST请求，后端通常用@RequestBody并使用一个类来接受请求体的内容，在类中添加校验项后，只需要在参数上加@Valid或@Validated注解即可。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@RestController</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserOperateController</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@PostMapping</span><span class=o>(</span><span class=s>&#34;/user/add&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>UserVO</span> <span class=nf>addUser</span><span class=o>(</span><span class=nd>@Valid</span> <span class=nd>@RequestBody</span> <span class=n>UserVO</span> <span class=n>userVO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;add user&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=统一处理校验错误>统一处理校验错误</h3><p>当参数校验失败时，Spring会抛出异常，在不同场景下抛出的异常有所不同，具体区别如下：</p><table><thead><tr><th>HTTP请求</th><th>参数注解</th><th>抛出异常类型</th><th>HTTP 返回状态码</th></tr></thead><tbody><tr><td>GET</td><td>无注解</td><td>BindException</td><td>400</td></tr><tr><td>GET</td><td>RequestParam</td><td>MethodArgumentNotValidException</td><td>500</td></tr><tr><td>GET</td><td>PathVariable</td><td>MethodArgumentNotValidException</td><td>500</td></tr><tr><td>POST</td><td>RequestBody</td><td>ConstraintViolationException</td><td>400</td></tr></tbody></table><p>如果想要返回统一的结构或针对校验失败返回统一的状态码，有两种方法。</p><p>如果只针对某一个Controller设置，则可以在该Controller中新增一个方法，处理抛出的异常，并返回400：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ExceptionHandler</span><span class=o>(</span><span class=n>ConstraintViolationException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@ResponseStatus</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>BAD_REQUEST</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=n>ResponseEntity</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=nf>handleConstraintViolationException</span><span class=o>(</span><span class=n>ConstraintViolationException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=n>ResponseEntity</span><span class=o>&lt;&gt;(</span><span class=s>&#34;参数校验失败：&#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>(),</span> <span class=n>HttpStatus</span><span class=o>.</span><span class=na>BAD_REQUEST</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果想针对全局配置，则可以添加一个全局处理类，用@ControllerAdvice注解。下面的两个方法分别处理ConstraintViolationException和MethodArgumentNotValidException，并返回了一个统一的结构HttpResponse。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HttpResponse</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Serializable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>serialVersionUID</span> <span class=o>=</span> <span class=o>-</span><span class=mi>5831412260861490028L</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>status</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>msg</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>T</span> <span class=n>data</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ControllerAdvice</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ValidateControllerAdvice</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ExceptionHandler</span><span class=o>(</span><span class=n>ConstraintViolationException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ResponseStatus</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>BAD_REQUEST</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ResponseBody</span>
</span></span><span class=line><span class=cl>    <span class=n>HttpResponse</span><span class=o>&lt;?&gt;</span> <span class=n>onConstraintValidationException</span><span class=o>(</span><span class=n>ConstraintViolationException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取错误
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>String</span> <span class=n>errorMsg</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>getConstraintViolations</span><span class=o>().</span><span class=na>stream</span><span class=o>().</span><span class=na>map</span><span class=o>(</span><span class=n>ConstraintViolation</span><span class=o>::</span><span class=n>getMessage</span><span class=o>).</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>joining</span><span class=o>(</span><span class=s>&#34; &#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 构造统一返回结果
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>HttpResponse</span><span class=o>&lt;?&gt;</span> <span class=n>response</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpResponse</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setStatus</span><span class=o>(</span><span class=mi>500</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setData</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setMsg</span><span class=o>(</span><span class=n>errorMsg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@ResponseBody</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ResponseStatus</span><span class=o>(</span><span class=n>HttpStatus</span><span class=o>.</span><span class=na>BAD_REQUEST</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nd>@ExceptionHandler</span><span class=o>(</span><span class=n>MethodArgumentNotValidException</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=n>HttpResponse</span><span class=o>&lt;?&gt;</span> <span class=n>onConstraintViolationException</span><span class=o>(</span><span class=n>MethodArgumentNotValidException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取错误
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>String</span> <span class=n>errorMsg</span> <span class=o>=</span> <span class=n>e</span><span class=o>.</span><span class=na>getBindingResult</span><span class=o>().</span><span class=na>getFieldErrors</span><span class=o>().</span><span class=na>stream</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>map</span><span class=o>(</span><span class=n>DefaultMessageSourceResolvable</span><span class=o>::</span><span class=n>getDefaultMessage</span><span class=o>).</span><span class=na>collect</span><span class=o>(</span><span class=n>Collectors</span><span class=o>.</span><span class=na>joining</span><span class=o>(</span><span class=s>&#34; &#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 构造统一返回结果
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>HttpResponse</span><span class=o>&lt;?&gt;</span> <span class=n>response</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpResponse</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setStatus</span><span class=o>(</span><span class=mi>500</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setData</span><span class=o>(</span><span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span><span class=o>.</span><span class=na>setMsg</span><span class=o>(</span><span class=n>errorMsg</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Controller中处理方法优先级比全局的处理类高。</p><h2 id=自定义校验器>自定义校验器</h2><p>如果javax.validation.constraints中的校验器不满足校验要求，还可以自定义一个校验注解和校验器。</p><p>例如我们给UserVO增加一个身份证属性并对其进行校验。首先定义校验注解，定义的注解中必须包含以下内容：</p><ol><li>message，当校验不通过时的提示信息，默认的信息从ValidationMessages.properties指定</li><li>groups，分组校验的组别</li><li>payload，用处较少</li><li>Constraint注解，指定校验器</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=o>({</span><span class=n>ElementType</span><span class=o>.</span><span class=na>FIELD</span><span class=o>})</span>
</span></span><span class=line><span class=cl><span class=nd>@Retention</span><span class=o>(</span><span class=n>RetentionPolicy</span><span class=o>.</span><span class=na>RUNTIME</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Constraint</span><span class=o>(</span><span class=n>validatedBy</span> <span class=o>=</span> <span class=n>IdCardNoValidator</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Documented</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=nd>@interface</span> <span class=n>IdCardNo</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=nf>message</span><span class=o>()</span> <span class=k>default</span> <span class=s>&#34;{IdCardNo.invalid}&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>groups</span><span class=o>()</span> <span class=k>default</span> <span class=o>{};</span>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Payload</span><span class=o>&gt;[]</span> <span class=nf>payload</span><span class=o>()</span> <span class=k>default</span> <span class=o>{};</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对应的校验类必须实现ConstraintValidator接口，接口的第一个范型为实际要校验的注解，第二个为校验的类型。</p><p>在isValid方法中进行实际的校验，第一个方法参数是要校验的对象，第二个是校验的上下文信息，可以使用该对象自定义错误信息(详见：<a href=https://blog.csdn.net/qq_38218238/article/details/81477915>Validator校验器中重新定义默认的错误信息模板</a>)。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>IdCardNoValidator</span> <span class=kd>implements</span> <span class=n>ConstraintValidator</span><span class=o>&lt;</span><span class=n>IdCardNo</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl> 	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isValid</span><span class=o>(</span><span class=n>String</span> <span class=n>value</span><span class=o>,</span> <span class=n>ConstraintValidatorContext</span> <span class=n>context</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>validateCard</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>validateCard</span><span class=o>(</span><span class=n>String</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 略
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>具体使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Data</span>
</span></span><span class=line><span class=cl><span class=nd>@Builder</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserVO</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nd>@IdCardNo</span><span class=o>(</span><span class=n>message</span> <span class=o>=</span> <span class=s>&#34;身份证号格式错误&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=n>String</span> <span class=n>idCardNo</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=service层进行校验>Service层进行校验</h2><p>除了在Controller层对用户输入校验，还可以在Serivce层进行校验。校验方法是在接口方法及实现方法中给需校验的参数加@Valid注解，在实现类上加@Validated注解。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>UserOperateService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=nd>@Valid</span> <span class=n>UserVO</span> <span class=n>userVO</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@Service</span>
</span></span><span class=line><span class=cl><span class=nd>@Validated</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>UserOperateServiceImpl</span> <span class=kd>implements</span> <span class=n>UserOperateService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>addUser</span><span class=o>(</span><span class=nd>@Valid</span> <span class=n>UserVO</span> <span class=n>userVO</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;[addUser] userVO: {}&#34;</span><span class=o>,</span> <span class=n>JsonUtil</span><span class=o>.</span><span class=na>object2Json</span><span class=o>(</span><span class=n>userVO</span><span class=o>));</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=显式校验>显式校验</h2><p>在没有Spring框架的情况下，如果也需要对参数进行校验，可以直接调用Hiberate的方法对参数进行校验。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>class</span> <span class=nc>ProgrammaticallyValidatingService</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>validateInput</span><span class=o>(</span><span class=n>Input</span> <span class=n>input</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ValidatorFactory</span> <span class=n>factory</span> <span class=o>=</span> <span class=n>Validation</span><span class=o>.</span><span class=na>buildDefaultValidatorFactory</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Validator</span> <span class=n>validator</span> <span class=o>=</span> <span class=n>factory</span><span class=o>.</span><span class=na>getValidator</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>ConstraintViolation</span><span class=o>&lt;</span><span class=n>Input</span><span class=o>&gt;&gt;</span> <span class=n>violations</span> <span class=o>=</span> <span class=n>validator</span><span class=o>.</span><span class=na>validate</span><span class=o>(</span><span class=n>input</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>violations</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=n>ConstraintViolationException</span><span class=o>(</span><span class=n>violations</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>  <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这种方式会在每次校验的时候创建一个ValidatorFactory和Validator，而参数校验的时候会获取校验类的所有远数据并缓存起来，提高下次校验时的校验速度。但是每次重新创建，该缓存会失效，所以对于频繁调用的方法，不建议使用这种方式进行校验。</p><p>而ValidatorFactory和Validator都是线程安全的，因此一个Application中只用一个ValidatorFactory单例即可。</p><h1 id=spring参数校验源码分析>Spring参数校验源码分析</h1><h2 id=校验类加载>校验类加载</h2><p>Spring Boot中加载校验类的配置类为ValidationAutoConfiguration，该类为容器中提供了两个类：</p><ul><li>LocalValidatorFactoryBean，当容器中不存在Validator时，作为默认的校验器。</li><li>MethodValidationPostProcessor，是一个BeanPostProcessor，在应用中Bean初始化完成后，会判断Bean是否使用了@Validated注解，如果使用了则给该Bean的方法加上校验的切面。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@AutoConfiguration</span>
</span></span><span class=line><span class=cl><span class=nd>@ConditionalOnClass</span><span class=o>(</span><span class=n>ExecutableValidator</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@ConditionalOnResource</span><span class=o>(</span><span class=n>resources</span> <span class=o>=</span> <span class=s>&#34;classpath:META-INF/services/javax.validation.spi.ValidationProvider&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nd>@Import</span><span class=o>(</span><span class=n>PrimaryDefaultValidatorPostProcessor</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ValidationAutoConfiguration</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Role</span><span class=o>(</span><span class=n>BeanDefinition</span><span class=o>.</span><span class=na>ROLE_INFRASTRUCTURE</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=nd>@ConditionalOnMissingBean</span><span class=o>(</span><span class=n>Validator</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>static</span> <span class=n>LocalValidatorFactoryBean</span> <span class=nf>defaultValidator</span><span class=o>(</span><span class=n>ApplicationContext</span> <span class=n>applicationContext</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>LocalValidatorFactoryBean</span> <span class=n>factoryBean</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LocalValidatorFactoryBean</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=n>MessageInterpolatorFactory</span> <span class=n>interpolatorFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MessageInterpolatorFactory</span><span class=o>(</span><span class=n>applicationContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>factoryBean</span><span class=o>.</span><span class=na>setMessageInterpolator</span><span class=o>(</span><span class=n>interpolatorFactory</span><span class=o>.</span><span class=na>getObject</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>factoryBean</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Bean</span>
</span></span><span class=line><span class=cl>	<span class=nd>@ConditionalOnMissingBean</span><span class=o>(</span><span class=n>search</span> <span class=o>=</span> <span class=n>SearchStrategy</span><span class=o>.</span><span class=na>CURRENT</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>static</span> <span class=n>MethodValidationPostProcessor</span> <span class=nf>methodValidationPostProcessor</span><span class=o>(</span><span class=n>Environment</span> <span class=n>environment</span><span class=o>,</span>
</span></span><span class=line><span class=cl>			<span class=nd>@Lazy</span> <span class=n>Validator</span> <span class=n>validator</span><span class=o>,</span> <span class=n>ObjectProvider</span><span class=o>&lt;</span><span class=n>MethodValidationExcludeFilter</span><span class=o>&gt;</span> <span class=n>excludeFilters</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>FilteredMethodValidationPostProcessor</span> <span class=n>processor</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FilteredMethodValidationPostProcessor</span><span class=o>(</span>
</span></span><span class=line><span class=cl>				<span class=n>excludeFilters</span><span class=o>.</span><span class=na>orderedStream</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=kt>boolean</span> <span class=n>proxyTargetClass</span> <span class=o>=</span> <span class=n>environment</span><span class=o>.</span><span class=na>getProperty</span><span class=o>(</span><span class=s>&#34;spring.aop.proxy-target-class&#34;</span><span class=o>,</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>processor</span><span class=o>.</span><span class=na>setProxyTargetClass</span><span class=o>(</span><span class=n>proxyTargetClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>processor</span><span class=o>.</span><span class=na>setValidator</span><span class=o>(</span><span class=n>validator</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>processor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=校验切面>校验切面</h3><p>在ValidationAutoConfiguration中提供的MethodValidationPostProcessor的继承关系为：</p><figure class=align-center><img src=https://blog-1302636809.file.myqcloud.com/post/java-bean-validation-with-spring-boot/images/MethodValidationPostProcessor.png></figure><p>在MethodValidationPostProcessor中加载了一个DefaultPointcutAdvisor，包含的pointcut为AnnotationMatchingPointcut，关注的是有Validated注解的类；包含的advise为MethodValidationInterceptor，进行实际的参数校验。</p><p>MethodValidationInterceptor的校验部分：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>invoke</span><span class=o>(</span><span class=n>MethodInvocation</span> <span class=n>invocation</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Throwable</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Avoid Validator invocation on FactoryBean.getObjectType/isSingleton
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>isFactoryBeanMetadataMethod</span><span class=o>(</span><span class=n>invocation</span><span class=o>.</span><span class=na>getMethod</span><span class=o>()))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>invocation</span><span class=o>.</span><span class=na>proceed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Class</span><span class=o>&lt;?&gt;[]</span> <span class=n>groups</span> <span class=o>=</span> <span class=n>determineValidationGroups</span><span class=o>(</span><span class=n>invocation</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// Standard Bean Validation 1.1 API
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>ExecutableValidator</span> <span class=n>execVal</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>validator</span><span class=o>.</span><span class=na>forExecutables</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Method</span> <span class=n>methodToValidate</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getMethod</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>ConstraintViolation</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;&gt;</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>target</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getThis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Assert</span><span class=o>.</span><span class=na>state</span><span class=o>(</span><span class=n>target</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>,</span> <span class=s>&#34;Target must not be null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 执行方法前检验参数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>execVal</span><span class=o>.</span><span class=na>validateParameters</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>methodToValidate</span><span class=o>,</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getArguments</span><span class=o>(),</span> <span class=n>groups</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>catch</span> <span class=o>(</span><span class=n>IllegalArgumentException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Probably a generic type mismatch between interface and impl as reported in SPR-12237 / HV-1011
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Let&#39;s try to find the bridged method on the implementation class...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>methodToValidate</span> <span class=o>=</span> <span class=n>BridgeMethodResolver</span><span class=o>.</span><span class=na>findBridgedMethod</span><span class=o>(</span>
</span></span><span class=line><span class=cl>                <span class=n>ClassUtils</span><span class=o>.</span><span class=na>getMostSpecificMethod</span><span class=o>(</span><span class=n>invocation</span><span class=o>.</span><span class=na>getMethod</span><span class=o>(),</span> <span class=n>target</span><span class=o>.</span><span class=na>getClass</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>execVal</span><span class=o>.</span><span class=na>validateParameters</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>methodToValidate</span><span class=o>,</span> <span class=n>invocation</span><span class=o>.</span><span class=na>getArguments</span><span class=o>(),</span> <span class=n>groups</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>result</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果有校验不通过，则抛出ConstraintViolationException
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ConstraintViolationException</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>returnValue</span> <span class=o>=</span> <span class=n>invocation</span><span class=o>.</span><span class=na>proceed</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调用结束后校验返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>result</span> <span class=o>=</span> <span class=n>execVal</span><span class=o>.</span><span class=na>validateReturnValue</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>methodToValidate</span><span class=o>,</span> <span class=n>returnValue</span><span class=o>,</span> <span class=n>groups</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(!</span><span class=n>result</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 如果有校验不通过，则抛出ConstraintViolationException
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ConstraintViolationException</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>returnValue</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=post参数校验>POST参数校验</h2><p>Spring处理Http请求时首先根据请求URL定位到要实际调用的方法，然后根据要调用的方法参数确定请求参数的解析类。</p><p>对于用RequestBody注解的参数，使用解析类为RequestResponseBodyMethodProcessor，在对参数解析完成后，会对参数进行校验。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=n>Object</span> <span class=nf>resolveArgument</span><span class=o>(</span><span class=n>MethodParameter</span> <span class=n>parameter</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>ModelAndViewContainer</span> <span class=n>mavContainer</span><span class=o>,</span>
</span></span><span class=line><span class=cl>        <span class=n>NativeWebRequest</span> <span class=n>webRequest</span><span class=o>,</span> <span class=nd>@Nullable</span> <span class=n>WebDataBinderFactory</span> <span class=n>binderFactory</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>Exception</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>parameter</span> <span class=o>=</span> <span class=n>parameter</span><span class=o>.</span><span class=na>nestedIfOptional</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=n>Object</span> <span class=n>arg</span> <span class=o>=</span> <span class=n>readWithMessageConverters</span><span class=o>(</span><span class=n>webRequest</span><span class=o>,</span> <span class=n>parameter</span><span class=o>,</span> <span class=n>parameter</span><span class=o>.</span><span class=na>getNestedGenericParameterType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>name</span> <span class=o>=</span> <span class=n>Conventions</span><span class=o>.</span><span class=na>getVariableNameForParameter</span><span class=o>(</span><span class=n>parameter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>(</span><span class=n>binderFactory</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>WebDataBinder</span> <span class=n>binder</span> <span class=o>=</span> <span class=n>binderFactory</span><span class=o>.</span><span class=na>createBinder</span><span class=o>(</span><span class=n>webRequest</span><span class=o>,</span> <span class=n>arg</span><span class=o>,</span> <span class=n>name</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>arg</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 校验参数
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>validateIfApplicable</span><span class=o>(</span><span class=n>binder</span><span class=o>,</span> <span class=n>parameter</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>binder</span><span class=o>.</span><span class=na>getBindingResult</span><span class=o>().</span><span class=na>hasErrors</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=n>isBindExceptionRequired</span><span class=o>(</span><span class=n>binder</span><span class=o>,</span> <span class=n>parameter</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>throw</span> <span class=k>new</span> <span class=n>MethodArgumentNotValidException</span><span class=o>(</span><span class=n>parameter</span><span class=o>,</span> <span class=n>binder</span><span class=o>.</span><span class=na>getBindingResult</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(</span><span class=n>mavContainer</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>mavContainer</span><span class=o>.</span><span class=na>addAttribute</span><span class=o>(</span><span class=n>BindingResult</span><span class=o>.</span><span class=na>MODEL_KEY_PREFIX</span> <span class=o>+</span> <span class=n>name</span><span class=o>,</span> <span class=n>binder</span><span class=o>.</span><span class=na>getBindingResult</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>adaptArgumentIfNecessary</span><span class=o>(</span><span class=n>arg</span><span class=o>,</span> <span class=n>parameter</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=get参数校验>GET参数校验</h2><p>对于GET参数的校验则不是在校验类中实现的，而是利用了Spring的AOP机制。所以对于GET请求的方法，其Controller类必须加@Validated注解。</p><p>具体代码见校验切面，这里不再赘述。</p><h1 id=总结>总结</h1><p>Spring中可以使用Hibernate Bean Validation对POST、GET等请求方法的入参做校验，也可以对业务逻辑层做校验。</p><p>Spring中的校验可以是JSR 380定义的校验器，也可以自定义校验器。</p><p>对于POST方法，只需对参数加@Valid注解即可，GET方法则须对Controller类加@Validated注解。</p><p>Spring中，POST方法进行校验是在参数解析时直接调用Hibernate的校验器校验；对GET方法的校验则是使用AOP实现。</p><h1 id=参考文献>参考文献</h1><ol><li><a href="https://jcp.org/en/jsr/summary?id=Bean+Validation">The Java Community Process(SM) Program - JSRs: Java Specification Requests - summary</a></li><li><a href=https://beanvalidation.org/news/>Jakarta Bean Validation - News</a></li><li><a href=https://hibernate.org/validator/>The Bean Validation reference implementation. - Hibernate Validator</a></li><li><a href=https://www.baeldung.com/javax-validation>Java Bean Validation Basics</a></li><li><a href=https://segmentfault.com/a/1190000023471742#item-1-3>java - Spring Validation最佳实践及其实现原理，参数校验没那么简单！ - 个人文章 - SegmentFault 思否</a></li><li><a href=https://docs.spring.io/spring-framework/docs/current/reference/html/integration.html#rest-http-interface-method-parameters>Spring Method Parameter</a></li><li><a href=https://docs.jboss.org/hibernate/validator/8.0/reference/en-US/html_single/#chapter-bootstrapping>Hibernate Validator 8.0.0.Final - Jakarta Bean Validation Reference Implementation: Reference Guide</a></li></ol><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Gum</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2023-01-30</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/java/>Java</a>
<a href=/tags/spring/>Spring</a></div><nav class=post-nav><a class=prev href=/post/xiehe-icl/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">协和ICL手术过程记录</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/build-ci-system/><span class="next-text nav-default">使用Github Action和阿里云容器镜像服务搭建CI系统</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=Gummary/blog-comment issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:sdythp@gmail.com class="iconfont icon-email" title=email target=_blank></a>
<a href=https://github.com/Gummary/ class="iconfont icon-github" title=github target=_blank></a>
<a href=http://localhost:1313/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=poem>What I cannot create, I do not understand.</div><div class=copyright><span class=copyright-year><span>Gum</span>
&copy;
2017 -
2023</span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script>
<script type=text/javascript>window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script async src=https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin=anonymous></script></body></html>